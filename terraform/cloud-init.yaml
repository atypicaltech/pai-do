#cloud-config
package_update: true
package_upgrade: true

packages:
  - ufw
  - fail2ban
  - curl
  - jq
  - golang-go

fs_setup:
  - label: pai-data
    device: /dev/disk/by-id/scsi-0DO_Volume_${volume_name}
    filesystem: ext4
    overwrite: false

mounts:
  - ["/dev/disk/by-id/scsi-0DO_Volume_${volume_name}",
     "/mnt/pai-data", "ext4", "defaults,nofail,discard", "0", "2"]

write_files:
  # Fail2ban jail config
  - path: /etc/fail2ban/jail.local
    content: |
      [DEFAULT]
      bantime = 3600
      findtime = 600
      maxretry = 5

      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 3
      bantime = 7200

  # Claude Code settings.json with TelegramBridge config
  # Written directly to persistent volume (mounted by fs_setup before write_files)
  - path: /mnt/pai-data/claude/settings.json
    permissions: '0600'
    content: |
      {
        "permissions": {
          "allow": [
            "Bash",
            "Read",
            "Write",
            "Edit",
            "Glob",
            "Grep",
            "WebFetch",
            "NotebookEdit"
          ]
        },
        "env": {
          "TELEGRAM_BOT_TOKEN": "${telegram_bot_token}"
        },
        "telegramBridge": {
          "enabled": true,
          "allowed_users": [${telegram_allowed_users}],
          "polling_mode": "long-polling",
          "sessions": {
            "timeout_minutes": 30,
            "max_concurrent": 2,
            "default_work_dir": "~/projects",
            "default_model": "claude-opus-4-6"
          },
          "security": {
            "require_passphrase": false,
            "rate_limit_per_minute": 10
          },
          "response": {
            "format": "full",
            "forward_progress": true
          },
          "server": {
            "port": 7777
          }
        }
      }

  # Claude Code onboarding bypass for headless auth
  - path: /root/.claude.json
    permissions: '0600'
    content: |
      {
        "hasCompletedOnboarding": true
      }

  # PAI Telegram Bridge systemd service
  - path: /etc/systemd/system/pai-telegram-bridge.service
    content: |
      [Unit]
      Description=PAI Telegram Bridge
      After=network-online.target
      Wants=network-online.target
      RequiresMountsFor=/mnt/pai-data

      [Service]
      Type=simple
      User=root
      Environment=HOME=/root
      Environment=CLAUDE_CODE_OAUTH_TOKEN=${claude_oauth_token}
      Environment=PATH=/root/.local/bin:/usr/local/bin:/usr/bin:/bin
      ExecStartPre=/bin/test -L /root/.claude
      ExecStartPre=/bin/test -f /root/.claude/settings.json
      ExecStart=/usr/local/bin/pai-bridge
      Restart=always
      RestartSec=10
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target

  # Bridge source - go.mod
  - path: /root/bridge-go/go.mod
    content: |
      ${indent(6, go_mod)}

  # Bridge source - go.sum
  - path: /root/bridge-go/go.sum
    content: |
      ${indent(6, go_sum)}

  # Bridge source - main.go
  - path: /root/bridge-go/main.go
    content: |
      ${indent(6, main_go)}

  # Bridge source - config.go
  - path: /root/bridge-go/config.go
    content: |
      ${indent(6, config_go)}

  # Bridge source - bot.go
  - path: /root/bridge-go/bot.go
    content: |
      ${indent(6, bot_go)}

  # Bridge source - session.go
  - path: /root/bridge-go/session.go
    content: |
      ${indent(6, session_go)}

  # Bridge source - format.go
  - path: /root/bridge-go/format.go
    content: |
      ${indent(6, format_go)}

  # PAI setup script
  - path: /root/setup-pai.sh
    permissions: '0700'
    content: |
      #!/bin/bash
      export HOME=/root
      export PATH="$PATH:/usr/local/bin:/root/.local/bin"
      LOG=/var/log/pai-setup.log

      log() { echo "$(date): $1" >> $LOG; }

      log "Starting PAI setup"

      # Set up persistent storage symlinks
      # Volume is already mounted at /mnt/pai-data by cloud-init fs_setup/mounts
      # settings.json is already written there by cloud-init write_files
      log "Setting up persistent storage symlinks..."

      # ~/.claude -> /mnt/pai-data/claude (settings.json already there)
      if [ ! -L ~/.claude ]; then
        rm -rf ~/.claude 2>/dev/null || true
        ln -s /mnt/pai-data/claude ~/.claude
        log "Created symlink ~/.claude -> /mnt/pai-data/claude"
      fi

      # ~/projects -> /mnt/pai-data/projects (user files persist across deploys)
      mkdir -p /mnt/pai-data/projects
      if [ ! -L ~/projects ]; then
        rm -rf ~/projects 2>/dev/null || true
        ln -s /mnt/pai-data/projects ~/projects
        log "Created symlink ~/projects -> /mnt/pai-data/projects"
      fi

      # 1. Install Claude Code (native binary, no Node.js needed)
      log "Installing Claude Code..."
      curl -fsSL https://claude.ai/install.sh | bash
      export PATH="$PATH:/root/.local/bin"
      hash -r

      CLAUDE_PATH=$(which claude 2>/dev/null || echo "")
      if [ -z "$CLAUDE_PATH" ]; then
        log "ERROR: Claude Code CLI not found after install"
        exit 1
      fi
      log "Claude Code installed at $CLAUDE_PATH ($(claude --version 2>/dev/null))"

      # 2. Build PAI Bridge from embedded source
      log "Building PAI Bridge..."
      cd /root/bridge-go
      CGO_ENABLED=0 go build -ldflags="-s -w" -o /usr/local/bin/pai-bridge .
      if [ $? -ne 0 ]; then
        log "ERROR: Go build failed"
        exit 1
      fi
      chmod +x /usr/local/bin/pai-bridge
      log "PAI Bridge built and installed at /usr/local/bin/pai-bridge"

      # 3. Create state directories on persistent volume
      mkdir -p /root/.claude/skills/TelegramBridge/state

      # 4. Enable and start the bridge service
      log "Starting PAI Telegram Bridge service..."
      systemctl daemon-reload
      systemctl enable pai-telegram-bridge
      systemctl start pai-telegram-bridge
      sleep 3

      if systemctl is-active pai-telegram-bridge >/dev/null 2>&1; then
        log "SUCCESS: PAI Telegram Bridge running"
      else
        log "WARNING: Bridge may not be running, checking logs..."
        journalctl -u pai-telegram-bridge --no-pager -n 20 >> $LOG
      fi

      log "Setup complete - access via Telegram bot"
      rm -f /root/setup-pai.sh

runcmd:
  # Setup fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Setup UFW firewall - SSH only
  - ufw --force enable
  - ufw allow ssh
  - ufw logging on

  # Install Tailscale
  - curl -fsSL https://tailscale.com/install.sh | sh
  - tailscale up --auth-key="${tailscale_auth_key}" --hostname=pai-prod

  # Run PAI setup
  - /root/setup-pai.sh

  # Security hardening
  - sed -i 's/#PasswordAuthentication yes/PasswordAuthentication no/' /etc/ssh/sshd_config
  - systemctl restart ssh
