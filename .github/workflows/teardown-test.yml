name: Teardown Test VM

on:
  workflow_dispatch:
    inputs:
      snapshot_id:
        description: 'Packer snapshot ID to delete (optional)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  teardown:
    name: Destroy Test Resources
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Install doctl
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DO_TOKEN }}

      - name: Destroy Test Droplet
        run: |
          DROPLET_ID=$(doctl compute droplet list --format ID,Name --no-header | grep pai-test | awk '{print $1}')
          if [ -n "$DROPLET_ID" ]; then
            doctl compute droplet delete "$DROPLET_ID" --force
            echo "Destroyed droplet pai-test (ID: $DROPLET_ID)"
          else
            echo "No pai-test droplet found"
          fi

      - name: Delete Snapshot
        if: inputs.snapshot_id != ''
        run: |
          doctl compute snapshot delete "${{ inputs.snapshot_id }}" --force
          echo "Deleted snapshot ${{ inputs.snapshot_id }}"

      - name: Output Summary
        run: |
          echo "### Test Resources Cleaned Up" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Droplet \`pai-test\`: destroyed" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ inputs.snapshot_id }}" ]; then
            echo "- Snapshot \`${{ inputs.snapshot_id }}\`: deleted" >> $GITHUB_STEP_SUMMARY
          else
            echo "- Snapshot: not specified (skipped)" >> $GITHUB_STEP_SUMMARY
          fi
