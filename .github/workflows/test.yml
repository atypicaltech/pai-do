name: Test PAI Bridge

on:
  push:
    branches: [main]
    paths: ['bridge-go/**']
  pull_request:
    branches: [main]
    paths: ['bridge-go/**']

permissions:
  contents: read

jobs:
  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 10

    defaults:
      run:
        working-directory: bridge-go

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: bridge-go/go.mod

      - name: Run tests with coverage
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Generate coverage report
        run: |
          go tool cover -func=coverage.out -o coverage-summary.txt
          go tool cover -html=coverage.out -o coverage.html

      - name: Display coverage summary
        run: cat coverage-summary.txt

      - name: Post coverage to job summary
        run: |
          TOTAL=$(go tool cover -func=coverage.out | grep ^total | awk '{print $3}')
          echo "### Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total Coverage: ${TOTAL}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Coverage |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|" >> $GITHUB_STEP_SUMMARY
          go tool cover -func=coverage.out | grep -v ^total | while read -r line; do
            FILE=$(echo "$line" | awk '{print $1}')
            FUNC=$(echo "$line" | awk '{print $2}')
            COV=$(echo "$line" | awk '{print $3}')
            echo "| \`${FILE}\` ${FUNC} | ${COV} |" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Coverage report generated by \`go test -coverprofile\`*" >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            bridge-go/coverage.out
            bridge-go/coverage.html
            bridge-go/coverage-summary.txt
          retention-days: 30

      - name: Check coverage threshold
        run: |
          TOTAL=$(go tool cover -func=coverage.out | grep ^total | awk '{print $3}' | sed 's/%//')
          echo "Coverage: ${TOTAL}%"
          THRESHOLD=10
          if [ "$(echo "${TOTAL} < ${THRESHOLD}" | bc -l)" -eq 1 ]; then
            echo "::error::Coverage ${TOTAL}% is below threshold ${THRESHOLD}%"
            exit 1
          fi
