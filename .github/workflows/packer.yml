name: Build PAI Base Image

on:
  pull_request:
    paths: ['packer/**']
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: Build Snapshot
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      snapshot_id: ${{ steps.get-snapshot.outputs.snapshot_id }}

    defaults:
      run:
        working-directory: packer

    steps:
      - uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: latest

      - name: Packer Init
        run: packer init pai-base.pkr.hcl

      - name: Packer Validate
        run: packer validate pai-base.pkr.hcl
        env:
          PKR_VAR_do_token: ${{ secrets.DO_TOKEN }}

      - name: Packer Build
        run: packer build -color=false pai-base.pkr.hcl
        env:
          PKR_VAR_do_token: ${{ secrets.DO_TOKEN }}

      - name: Get Snapshot ID
        id: get-snapshot
        if: success()
        run: |
          RAW_ID=$(jq -r '.builds[-1].artifact_id' manifest.json)
          # Packer DO builder outputs "region:id" format â€” extract just the numeric ID
          SNAPSHOT_ID="${RAW_ID##*:}"
          echo "snapshot_id=$SNAPSHOT_ID" >> $GITHUB_OUTPUT
          echo "Raw artifact ID: $RAW_ID"
          echo "Snapshot ID: $SNAPSHOT_ID"

      - name: Output Summary
        if: success()
        run: |
          echo "### PAI Base Image Built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Snapshot ID:** \`${{ steps.get-snapshot.outputs.snapshot_id }}\`" >> $GITHUB_STEP_SUMMARY

  deploy-test:
    name: Deploy Test VM
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: packer/test

    steps:
      - uses: actions/checkout@v4

      - uses: opentofu/setup-opentofu@v1
        with:
          tofu_version: '1.8.0'

      - name: OpenTofu Init
        run: tofu init

      - name: OpenTofu Apply
        run: tofu apply -auto-approve
        env:
          TF_VAR_do_token: ${{ secrets.DO_TOKEN }}
          TF_VAR_snapshot_id: ${{ needs.build.outputs.snapshot_id }}
          TF_VAR_ssh_fingerprint: ${{ secrets.SSH_FINGERPRINT }}
          TF_VAR_tailscale_auth_key: ${{ secrets.TAILSCALE_AUTH_KEY }}

      - name: Output Summary
        if: success()
        run: |
          DROPLET_IP=$(tofu output -raw droplet_ip)
          DROPLET_ID=$(tofu output -raw droplet_id)
          echo "### Test VM Deployed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Droplet ID:** \`${DROPLET_ID}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Public IP:** \`${DROPLET_IP}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Tailscale:** \`pai-test\`" >> $GITHUB_STEP_SUMMARY
          echo "**Snapshot:** \`${{ needs.build.outputs.snapshot_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "SSH in via: \`ssh root@pai-test\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Run **Teardown Test VM** workflow when done." >> $GITHUB_STEP_SUMMARY
